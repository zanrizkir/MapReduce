{% extends "base.html" %}

{% block title %}Chat Analyzer - MapReduce Web{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2><i class="fas fa-comments"></i> Chat Analyzer</h2>
        <p class="text-muted">Analisis statistik chat menggunakan MapReduce</p>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card shadow">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-edit"></i> Input Log Chat</h5>
            </div>
            <div class="card-body">
                <form id="chatForm">
                    <div class="mb-3">
                        <label for="dataInput" class="form-label">Masukkan Log Chat:</label>
                        <textarea class="form-control" id="dataInput" rows="12" 
                                  placeholder="Format: [Waktu] User: Pesan&#10;Contoh:&#10;[14:30] Andi: Halo apa kabar?&#10;[14:31] Budi: Baik, sedang belajar MapReduce"></textarea>
                        <div class="form-text">
                            Format: [Waktu] Username: Pesan
                        </div>
                    </div>
                    <button type="submit" class="btn btn-info" id="processBtn">
                        <i class="fas fa-play"></i> Proses MapReduce
                    </button>
                    <button type="button" class="btn btn-outline-secondary" onclick="loadExample()">
                        <i class="fas fa-file-alt"></i> Load Contoh
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div id="resultsSection" style="display: none;">
            <div class="card shadow mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-chart-bar"></i> Statistik Chat</h5>
                </div>
                <div class="card-body">
                    <div id="summary" class="mb-3"></div>
                    <div class="table-responsive">
                        <table class="table table-striped" id="resultsTable">
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Jumlah Pesan</th>
                                    <th>Total Kata</th>
                                    <th>Rata-rata Kata/Pesan</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div class="card shadow">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-chart-pie"></i> Visualisasi</h5>
                </div>
                <div class="card-body">
                    <canvas id="chatChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>
        
        <div id="processSteps" style="display: none;" class="mt-4">
            <div class="card shadow">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0"><i class="fas fa-cogs"></i> Proses MapReduce</h5>
                </div>
                <div class="card-body">
                    <div class="accordion" id="processAccordion">
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#mapPhase">
                                    <i class="fas fa-map-marked-alt me-2"></i>Map Phase
                                </button>
                            </h2>
                            <div id="mapPhase" class="accordion-collapse collapse show" data-bs-parent="#processAccordion">
                                <div class="accordion-body">
                                    <div id="mapResults" class="process-output"></div>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#shufflePhase">
                                    <i class="fas fa-random me-2"></i>Shuffle Phase
                                </button>
                            </h2>
                            <div id="shufflePhase" class="accordion-collapse collapse" data-bs-parent="#processAccordion">
                                <div class="accordion-body">
                                    <div id="shuffleResults" class="process-output"></div>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#reducePhase">
                                    <i class="fas fa-redo me-2"></i>Reduce Phase
                                </button>
                            </h2>
                            <div id="reducePhase" class="accordion-collapse collapse" data-bs-parent="#processAccordion">
                                <div class="accordion-body">
                                    <div id="reduceResults" class="process-output"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="initialState" class="text-center text-muted mt-5">
            <i class="fas fa-comments fa-4x mb-3"></i>
            <h5>Belum ada data yang diproses</h5>
            <p>Masukkan log chat di sebelah kiri dan klik "Proses MapReduce" untuk melihat hasil</p>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function loadExample() {
    document.getElementById('dataInput').value = `[14:30] Andi: Halo apa kabar?
[14:31] Budi: Baik, sedang belajar MapReduce
[14:32] Andi: Wah bagus sekali, saya juga sedang mempelajarinya
[14:33] Sari: Hello everyone, how are you doing today?
[14:34] Budi: I'm good, just working on this MapReduce project
[14:35] Andi: This JavaScript implementation is really interesting
[14:36] Sari: Yes, it's amazing how we can run MapReduce in browser
[14:37] Budi: The visualization features are also very helpful
[14:38] Andi: We should add more examples to demonstrate the power of MapReduce
[14:39] Sari: Definitely, this can be very useful for educational purposes
[14:40] Budi: Let's continue working on the project and add more features`;
}

document.getElementById('chatForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const processBtn = document.getElementById('processBtn');
    const originalText = processBtn.innerHTML;
    processBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Memproses...';
    processBtn.disabled = true;
    
    const data = document.getElementById('dataInput').value;
    
    fetch('/chat', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({data: data})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayResults(data);
            displayProcessSteps(data.process_steps);
            createChart(data.chart_data);
            document.getElementById('resultsSection').style.display = 'block';
            document.getElementById('processSteps').style.display = 'block';
            document.getElementById('initialState').style.display = 'none';
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Terjadi kesalahan saat memproses data');
    })
    .finally(() => {
        processBtn.innerHTML = originalText;
        processBtn.disabled = false;
    });
});

function displayResults(data) {
    const totals = data.totals;
    let summaryHTML = '<div class="alert alert-info">';
    summaryHTML += `<strong>Summary:</strong> ${totals.messages} total pesan`;
    summaryHTML += ` | <strong>${totals.words}</strong> total kata`;
    summaryHTML += ` | <strong>${totals.avg_per_message}</strong> kata per pesan (rata-rata)`;
    
    if (data.errors && data.errors.length > 0) {
        summaryHTML += ` | <strong>Error:</strong> ${data.errors.length} baris`;
    }
    
    summaryHTML += '</div>';
    document.getElementById('summary').innerHTML = summaryHTML;
    
    const tbody = document.querySelector('#resultsTable tbody');
    tbody.innerHTML = '';
    
    data.user_stats.sort((a, b) => b.messages - a.messages).forEach(user => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><strong>${user.username}</strong></td>
            <td><span class="badge bg-info">${user.messages}</span></td>
            <td><span class="badge bg-primary">${user.words}</span></td>
            <td>${user.avg_words}</td>
        `;
        tbody.appendChild(row);
    });
}

function displayProcessSteps(steps) {
    // Map Phase
    const mapResults = document.getElementById('mapResults');
    mapResults.innerHTML = steps.mapped.slice(0, 30).map(item => 
        `<div class="mb-1"><code>("${item[0]}", ${item[1]})</code></div>`
    ).join('');
    
    if (steps.mapped.length > 30) {
        mapResults.innerHTML += `<div class="text-muted">... dan ${steps.mapped.length - 30} data lainnya</div>`;
    }
    
    // Shuffle Phase
    const shuffleResults = document.getElementById('shuffleResults');
    shuffleResults.innerHTML = Object.entries(steps.shuffled).map(([key, values]) => 
        `<div class="mb-1"><strong>"${key}":</strong> [${values.join(', ')}]</div>`
    ).join('');
    
    // Reduce Phase
    const reduceResults = document.getElementById('reduceResults');
    reduceResults.innerHTML = steps.results.map(item => 
        `<div class="mb-1"><code>"${item[0]}" â†’ ${item[1]}</code></div>`
    ).join('');
}

function createChart(chartData) {
    const ctx = document.getElementById('chatChart').getContext('2d');
    
    if (window.chatChartInstance) {
        window.chatChartInstance.destroy();
    }
    
    window.chatChartInstance = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: chartData.labels,
            datasets: [{
                label: 'Jumlah Pesan',
                data: chartData.messages,
                backgroundColor: [
                    'rgba(54, 162, 235, 0.8)',
                    'rgba(255, 99, 132, 0.8)',
                    'rgba(255, 206, 86, 0.8)',
                    'rgba(75, 192, 192, 0.8)',
                    'rgba(153, 102, 255, 0.8)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'Distribusi Pesan per User'
                },
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

// Load initial example
loadExample();
</script>
{% endblock %}